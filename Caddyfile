# Caddyfile — 反向代理配置
#
# 将 {your-domain.com} 替换为你的实际域名
# Caddy 会自动从 Let's Encrypt 获取 SSL 证书
#
# 如果使用 Cloudflare 代理（推荐），SSL 模式设为 Full (Strict)
# Caddy 自签证书 + Cloudflare 之间全程加密

{$DOMAIN:your-domain.com} {
    # 反向代理到 Next.js 应用
    reverse_proxy app:3000

    # 安全响应头
    header {
        # 防止 MIME 类型嗅探
        X-Content-Type-Options "nosniff"
        # 防止点击劫持
        X-Frame-Options "DENY"
        # XSS 保护
        X-XSS-Protection "1; mode=block"
        # 引用策略
        Referrer-Policy "strict-origin-when-cross-origin"
        # 移除 Server 头
        -Server
    }

    # 静态资源长期缓存
    @static path /_next/static/*
    header @static Cache-Control "public, max-age=31536000, immutable"

    # 图标和 manifest 缓存
    @assets path /icons/* /manifest.json /sw.js
    header @assets Cache-Control "public, max-age=86400"

    # API 不缓存
    @api path /api/*
    header @api Cache-Control "no-store"

    # 访问日志
    log {
        output file /data/access.log {
            roll_size 10mb
            roll_keep 3
        }
    }
}
